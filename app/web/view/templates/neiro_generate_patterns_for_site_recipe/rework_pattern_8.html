<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrettyRecipeMaker - {{ recipe_data.name }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* Все стили остаются без изменений */
        /* ... */
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="header-title">
                <svg class="logo-wave" viewBox="0 0 100 50">
                    <path d="M0,25 C20,0 40,50 60,25 S100,0 100,25" fill="none" stroke="white" stroke-width="2"/>
                </svg>
                PrettyRecipeMaker
            </div>
            <div class="header-controls">
                <button class="control-btn" id="colorBtn"><i class="material-symbols-outlined">palette</i> Цвет</button>
                <button class="control-btn" id="fontBtn"><i class="material-symbols-outlined">text_fields</i> Шрифт</button>
                <button class="control-btn" id="tileBtn"><i class="material-symbols-outlined">widgets</i> Плитки</button>
                <button class="control-btn" id="bgBtn"><i class="material-symbols-outlined">image</i> Фон</button>
                <button class="control-btn" id="radiusBtn"><i class="material-symbols-outlined">rounded_corner</i> Углы</button>
                <button class="control-btn" id="zoomBtn"><i class="material-symbols-outlined">zoom_in</i> Зум</button>
                <button class="control-btn" id="layoutBtn"><i class="material-symbols-outlined">dashboard</i> Расположение</button>
                <button class="control-btn" id="uiBtn"><i class="material-symbols-outlined">settings</i> Интерфейс</button>
                <button class="control-btn" id="helpBtn"><i class="material-symbols-outlined">help</i> Помощь</button>
                <button class="control-btn" id="clearBtn"><i class="material-symbols-outlined">delete</i> Очистить</button>
            </div>
        </div>
    </header>
    
    <!-- Side panels -->
    <div id="colorPanel" class="side-panel">
        <span class="close-panel">&times;</span>
        <h3>Настройки цвета</h3>
        <!-- Содержимое панели цвета -->
    </div>
    
    <!-- Остальные панели -->
    <!-- ... -->
    
    <!-- Main content -->
    <main class="main-content">
        <div class="recipe-container" id="recipeContainer">
            <!-- Центральная карточка с рецептом -->
            <div class="recipe-card" id="recipeCard">
                <!-- Содержимое карточки -->
            </div>
            
            <!-- Базовые плитки -->
            <div class="tile" id="tile1" style="width: 280px; height: 180px; transform: rotate(5deg);">
                <!-- Содержимое плитки -->
            </div>
            <!-- Остальные плитки -->
            <!-- ... -->
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <span class="material-symbols-outlined footer-icon">home</span>
            <div class="footer-text">PrettyRecipeMaker</div>
            <span class="material-symbols-outlined footer-icon">person</span>
        </div>
    </footer>
    
    <!-- Save buttons -->
    <div style="position: fixed; left: 20px; bottom: 20px; z-index: 1000; display: flex; gap: 10px;">
        <button class="control-btn" id="saveHtmlBtn"><i class="material-symbols-outlined">download</i> Сохранить HTML</button>
        <button class="control-btn" id="savePngBtn"><i class="material-symbols-outlined">image</i> Сохранить PNG</button>
    </div>
    
    <!-- Контекстное меню -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" id="editTileBtn"><i class="material-symbols-outlined">edit</i> Редактировать</div>
        <div class="context-menu-item" id="deleteTileBtn"><i class="material-symbols-outlined">delete</i> Удалить</div>
        <div class="context-menu-item" id="connectCenterBtn"><i class="material-symbols-outlined">link</i> Соединить с центром</div>
        <div class="context-menu-item" id="connectTileBtn"><i class="material-symbols-outlined">link</i> Соединить с плиткой</div>
        <div class="context-menu-item" id="bringFrontBtn"><i class="material-symbols-outlined">layers</i> На передний план</div>
        <div class="context-menu-item" id="sendBackBtn"><i class="material-symbols-outlined">layers</i> На задний план</div>
    </div>
    
    <script>
        // Глобальные переменные
        let currentColorTarget = '';
        let tileCounter = 8;
        let isDragging = false;
        let dragStartX, dragStartY;
        let initialRecipeCardX = 200;
        let initialRecipeCardY = 150;
        let currentAngle = 0;
        let selectedTile = null;
        let connections = [];
        let selectedTiles = [];
        let isSelecting = false;
        let selectionStartX, selectionStartY;
        let selectionBox = null;
        
        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            // Назначение обработчиков событий
            document.getElementById('colorBtn').addEventListener('click', () => showPanel('colorPanel'));
            document.getElementById('fontBtn').addEventListener('click', () => showPanel('fontPanel'));
            document.getElementById('tileBtn').addEventListener('click', () => showPanel('tilePanel'));
            document.getElementById('bgBtn').addEventListener('click', () => showPanel('bgPanel'));
            document.getElementById('radiusBtn').addEventListener('click', () => showPanel('radiusPanel'));
            document.getElementById('zoomBtn').addEventListener('click', () => showPanel('zoomPanel'));
            document.getElementById('layoutBtn').addEventListener('click', () => showPanel('layoutPanel'));
            document.getElementById('uiBtn').addEventListener('click', () => showPanel('uiPanel'));
            document.getElementById('helpBtn').addEventListener('click', () => showPanel('helpPanel'));
            document.getElementById('clearBtn').addEventListener('click', clearAllTiles);
            document.getElementById('saveHtmlBtn').addEventListener('click', saveAsHTML);
            document.getElementById('savePngBtn').addEventListener('click', saveAsPNG);
            
            // Обработчики для контекстного меню
            document.getElementById('editTileBtn').addEventListener('click', editTile);
            document.getElementById('deleteTileBtn').addEventListener('click', deleteTile);
            document.getElementById('connectCenterBtn').addEventListener('click', connectToCenter);
            document.getElementById('connectTileBtn').addEventListener('click', connectToSelected);
            document.getElementById('bringFrontBtn').addEventListener('click', bringToFront);
            document.getElementById('sendBackBtn').addEventListener('click', sendToBack);
            
            // Закрытие панелей
            document.querySelectorAll('.close-panel').forEach(btn => {
                btn.addEventListener('click', function() {
                    const panel = this.closest('.side-panel');
                    hidePanel(panel.id);
                });
            });
            
            // Инициализация плиток
            positionInitialTiles();
            initTiles();
        });
        
        // Основные функции
        function showPanel(panelId) {
            document.querySelectorAll('.side-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(panelId).classList.add('active');
        }
        
        function hidePanel(panelId) {
            document.getElementById(panelId).classList.remove('active');
        }
        
        function clearAllTiles() {
            if (confirm('Вы уверены, что хотите удалить все плитки?')) {
                document.querySelectorAll('.tile').forEach(tile => {
                    if (tile.id !== 'recipeCard') tile.remove();
                });
                connections = [];
                updateConnections();
                tileCounter = 8;
            }
        }
        
        function initTiles() {
            document.querySelectorAll('.tile').forEach(tile => {
                if (tile.id !== 'recipeCard') {
                    makeTileDraggable(tile);
                    
                    tile.addEventListener('contextmenu', function(e) {
                        e.preventDefault();
                        showContextMenu(e, tile);
                    });
                    
                    tile.addEventListener('mousedown', function(e) {
                        if (e.button === 0 && !e.ctrlKey && !e.shiftKey) {
                            clearSelection();
                            selectTile(tile);
                        } else if (e.button === 0 && (e.ctrlKey || e.shiftKey)) {
                            toggleTileSelection(tile);
                        }
                    });
                }
            });
        }
        
        // Остальные функции (makeTileDraggable, selectTile, editTile и т.д.)
        // должны быть объявлены здесь, аналогично предыдущему коду
        
        // Исправленные SVG паттерны
        function getPatterns() {
            return [
                { 
                    name: 'Нет', 
                    style: 'none' 
                },
                { 
                    name: 'Шахматка', 
                    style: 'linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%, #f0f0f0), linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%, #f0f0f0); background-position: 0 0, 10px 10px; background-size: 20px 20px;' 
                },
                { 
                    name: 'Круги', 
                    style: 'radial-gradient(circle, #f0f0f0 20%, transparent 20%); background-size: 30px 30px;' 
                },
                // Остальные паттерны
            ];
        }
    </script>
</body>
</html>